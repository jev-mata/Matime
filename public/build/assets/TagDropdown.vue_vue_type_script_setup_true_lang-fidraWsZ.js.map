{"version":3,"file":"TagDropdown.vue_vue_type_script_setup_true_lang-fidraWsZ.js","sources":["../../../resources/js/packages/ui/src/Tag/TagDropdown.vue"],"sourcesContent":["<script setup lang=\"ts\">\nimport { PlusCircleIcon } from '@heroicons/vue/20/solid';\nimport Dropdown from '@/packages/ui/src/Input/Dropdown.vue';\nimport { type Component, computed, nextTick, ref, watch } from 'vue';\nimport TagCreateModal from '@/packages/ui/src/Tag/TagCreateModal.vue';\nimport MultiselectDropdownItem from '@/packages/ui/src/Input/MultiselectDropdownItem.vue';\nimport type { Tag } from '@/packages/api/src';\nimport {UseFocusTrap} from \"@vueuse/integrations/useFocusTrap/component\";\n\nconst props = withDefaults(\n    defineProps<{\n        tags: Tag[];\n        createTag: (name: string) => Promise<Tag | undefined>;\n        align?: 'center' | 'end' | 'start';\n    }>(),\n    {\n        align: 'start',\n    }\n);\n\nconst model = defineModel<string[]>({\n    default: [],\n});\n\nconst searchInput = ref<HTMLInputElement | null>(null);\nconst open = ref(false);\nconst dropdownViewport = ref<Component | null>(null);\n\nconst searchValue = ref('');\n\nfunction isTagSelected(id: string) {\n    return model.value.includes(id);\n}\n\nfunction addOrRemoveTagFromSelection(id: string) {\n    if (model.value.includes(id)) {\n        model.value = model.value.filter((tagId) => tagId !== id);\n    } else {\n        model.value = [...model.value, id];\n    }\n    emit('changed');\n}\n\nconst sortedTags = ref(props.tags);\n\nwatch(open, (isOpen) => {\n    if (isOpen) {\n        nextTick(() => {\n            searchInput.value?.focus();\n        });\n\n        // sort tags alphabetically\n        sortedTags.value = [...props.tags].sort((a, b) => {\n            const aIsSelected = model.value.includes(a.id);\n            const bIsSelected = model.value.includes(b.id);\n            if (aIsSelected === bIsSelected) {\n                return a.name.localeCompare(b.name);\n            }\n            return model.value.includes(a.id) ? -1 : 1;\n        });\n        nextTick(() => {\n            if (filteredTags.value.length > 0) {\n                highlightedItemId.value = filteredTags.value[0].id;\n            }\n        });\n    }\n});\n\nconst filteredTags = computed(() => {\n    return sortedTags.value.filter((tag: Tag) => {\n        return tag.name\n            .toLowerCase()\n            .includes(searchValue.value?.toLowerCase()?.trim() || '');\n    });\n});\n\nasync function createAndAddTag(name: string) {\n    const newTag = await props.createTag(name);\n    if (newTag) {\n        addOrRemoveTagFromSelection(newTag.id);\n    }\n    searchValue.value = '';\n    return newTag;\n}\n\nasync function addTagIfNoneExists() {\n    if (highlightedItemId.value) {\n        addOrRemoveTagFromSelection(highlightedItemId.value);\n    }\n}\n\nwatch(filteredTags, () => {\n    if (filteredTags.value.length > 0) {\n        highlightedItemId.value = filteredTags.value[0].id;\n    }\n});\n\nfunction updateSearchValue(event: Event) {\n    const newInput = (event.target as HTMLInputElement).value;\n    if (newInput === ' ') {\n        searchValue.value = '';\n        const highlightedTagId = highlightedItemId.value;\n        if (highlightedTagId) {\n            const highlightedTag = props.tags.find(\n                (tag) => tag.id === highlightedTagId\n            );\n            if (highlightedTag) {\n                addOrRemoveTagFromSelection(highlightedTag.id);\n            }\n        }\n    } else {\n        searchValue.value = newInput;\n    }\n}\n\nconst emit = defineEmits<{\n    changed: [];\n    submit: [];\n}>();\n\nfunction toggleTag(newValue: string) {\n    if (model.value.includes(newValue)) {\n        model.value = [...model.value].filter((id) => id !== newValue);\n    } else {\n        model.value = [...model.value, newValue];\n    }\n    emit('changed');\n}\n\nfunction moveHighlightUp() {\n    if (highlightedItem.value) {\n        const currentHightlightedIndex = filteredTags.value.indexOf(\n            highlightedItem.value\n        );\n        if (currentHightlightedIndex === 0) {\n            highlightedItemId.value =\n                filteredTags.value[filteredTags.value.length - 1].id;\n        } else {\n            highlightedItemId.value =\n                filteredTags.value[currentHightlightedIndex - 1].id;\n        }\n    }\n}\n\nfunction moveHighlightDown() {\n    if (highlightedItem.value) {\n        const currentHightlightedIndex = filteredTags.value.indexOf(\n            highlightedItem.value\n        );\n        if (currentHightlightedIndex === filteredTags.value.length - 1) {\n            highlightedItemId.value = filteredTags.value[0].id;\n        } else {\n            highlightedItemId.value =\n                filteredTags.value[currentHightlightedIndex + 1].id;\n        }\n    }\n}\n\nconst highlightedItemId = ref<string | null>(null);\nconst highlightedItem = computed(() => {\n    return props.tags.find((tag) => tag.id === highlightedItemId.value);\n});\n\nconst showCreateTagModal = ref(false);\n</script>\n\n<template>\n    <TagCreateModal\n        v-model:show=\"showCreateTagModal\"\n        :create-tag=\"createAndAddTag\"></TagCreateModal>\n    <Dropdown\n        v-model=\"open\"\n        :align=\"align\"\n        :close-on-content-click=\"false\"\n        @submit=\"emit('submit')\">\n        <template #trigger>\n            <slot name=\"trigger\"></slot>\n        </template>\n        <template #content>\n            <UseFocusTrap\n                v-if=\"open\"\n                :options=\"{ immediate: true, allowOutsideClick: true }\">\n                <input\n                    ref=\"searchInput\"\n                    :value=\"searchValue\"\n                    data-testid=\"tag_dropdown_search\"\n                    class=\"dark:bg-[#171E31] dark:text-[#BFC7D6] border-0 placeholder-muted text-sm text-text-primary py-2.5 focus:ring-0 border-b border-card-background-separator focus:border-card-background-separator w-full\"\n                    placeholder=\"Search for a Tag...\"\n                    @input=\"updateSearchValue\"\n                    @keydown.esc.prevent=\"open = false\"\n                    @keydown.enter=\"addTagIfNoneExists\"\n                    @keydown.up.prevent=\"moveHighlightUp\"\n                    @keydown.down.prevent=\"moveHighlightDown\" />\n                <div ref=\"dropdownViewport\" class=\"w-60 max-h-60 overflow-y-scroll\">\n                    <div\n                        v-for=\"tag in filteredTags\"\n                        :key=\"tag.id\"\n                        role=\"option\"\n                        :value=\"tag.id\"\n                        :class=\"{\n                        'bg-card-background-active':\n                            tag.id === highlightedItemId,\n                    }\"\n                        data-testid=\"tag_dropdown_entries\"\n                        :data-tag-id=\"tag.id\">\n                        <MultiselectDropdownItem\n                            :selected=\"isTagSelected(tag.id)\"\n                            :name=\"tag.name\"\n                            @click=\"toggleTag(tag.id)\"></MultiselectDropdownItem>\n                    </div>\n                </div>\n                <div class=\"hover:bg-card-background-active rounded-b-lg\">\n                    <button\n                        class=\"dark:bg-[#171E31] dark:text-[#BFC7D6] hover:bg-gray-600/10 hover:dark:bg-gray-800/80 w-full flex space-x-3 items-center px-4 py-3 text-xs font-semibold border-t dark:border-[#303F61] \"\n                        @click=\"\n                        open = false;\n                        showCreateTagModal = true;\n                    \">\n                        <PlusCircleIcon\n                            class=\"w-5 flex-shrink-0 text-icon-default\"></PlusCircleIcon>\n                        <span>Create new Tag</span>\n                    </button>\n                </div>\n            </UseFocusTrap>\n        </template>\n    </Dropdown>\n</template>\n\n<style scoped></style>\n"],"names":["props","__props","model","_useModel","searchInput","ref","open","dropdownViewport","searchValue","isTagSelected","id","addOrRemoveTagFromSelection","tagId","emit","sortedTags","watch","isOpen","nextTick","_a","a","b","aIsSelected","bIsSelected","filteredTags","highlightedItemId","computed","tag","_b","createAndAddTag","name","newTag","addTagIfNoneExists","updateSearchValue","event","newInput","highlightedTagId","highlightedTag","__emit","toggleTag","newValue","moveHighlightUp","highlightedItem","currentHightlightedIndex","moveHighlightDown","showCreateTagModal","_createVNode","TagCreateModal","$event","Dropdown","align","_renderSlot","_ctx","_createBlock","_unref","UseFocusTrap","_createElementVNode","_createElementBlock","_Fragment","_renderList","_normalizeClass","MultiselectDropdownItem","_hoisted_3","_cache","PlusCircleIcon"],"mappings":"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"}
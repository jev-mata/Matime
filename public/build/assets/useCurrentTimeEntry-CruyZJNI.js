import{C as j,r as T,H as M,l as k}from"./app-CZLkYVhz.js";import{b as F,u as A,a as s}from"./notification-BrLDF-00.js";import{d,u as $}from"./utc-YQln_hJX.js";import{a as g,g as o,c as S}from"./useUser-Dc3_Hjqo.js";import{g as L}from"./index-CHolqtoz.js";const N=j("timeEntries",()=>{const e=T(M([])),l=T(!1),{handleApiRequestNotifications:u}=F(),m=A();async function v(i={only_full_dates:"true",member_id:g()}){const a=o();if(a){const t=await u(()=>s.getTimeEntries({params:{organization:a},queries:i}),void 0,"Failed to fetch time entries");if(t!=null&&t.data){const n=t.data.filter(r=>!e.value.find(f=>f.id===r.id));e.value=[...n,...e.value]}}}async function c(i={only_full_dates:"true",member_id:g()}){const a=o();if(a){const t=await u(()=>s.getTimeEntries({params:{organization:a},queries:i}),void 0,"Failed to fetch time entries");t!=null&&t.data&&(e.value=t.data)}}async function y(){const i=o();if(i){const a=e.value[e.value.length-1];d(a.start).utc().format("YYYY-MM-DD");const t=await u(()=>s.getTimeEntries({params:{organization:i},queries:{only_full_dates:"true",member_id:g(),end:d(a.start).utc().format()}}),void 0,"Failed to fetch time entries");t!=null&&t.data&&t.data.length>0?e.value=e.value.concat(t.data):l.value=!0}}async function p(i,a){const t=o();t&&await u(()=>s.updateMultipleTimeEntries({ids:i,changes:a},{params:{organization:t}}),"Time entries updated successfully","Failed to update time entries")}async function z(i){const a=o();if(a){const t=await u(()=>s.updateTimeEntry(i,{params:{organization:a,timeEntry:i.id}}),"Time entry updated successfully","Failed to update time entry");e.value=e.value.map(n=>n.id===i.id?t.data:n),m.invalidateQueries({queryKey:["timeEntry"]})}await c()}async function _(i){const a=o(),t=g();if(a&&t!==void 0){const n={...i,member_id:t};await u(()=>s.createTimeEntry(n,{params:{organization:a}}),"Time entry created successfully","Failed to create time entry"),await c()}}async function b(i){const a=o();a&&(await u(()=>s.deleteTimeEntry(void 0,{params:{organization:a,timeEntry:i}}),"Time entry deleted successfully","Failed to delete time entry"),await c())}async function h(i,a){if(i){const t=o(),n=a.map(r=>r.id);t&&(await u(()=>s.deleteTimeEntries(void 0,{queries:{ids:n},params:{organization:t}}),"Time entries discarded successfully","Failed to discarded time entries"),D().$reset(),D().fetchCurrentTimeEntry(),await c())}else F().addNotification("error","Entries not found");c()}async function I(i,a){const t=o(),n=i.map(r=>r.id);t&&(await u(()=>s.deleteTimeEntries(void 0,{queries:{ids:n},params:{organization:t}}),a||"Time entries deleted successfully","Failed to delete time entries"),await c())}return{discardTimer:h,timeEntries:e,fetchTimeEntries:c,updateTimeEntry:z,createTimeEntry:_,deleteTimeEntry:b,fetchMoreTimeEntries:y,allTimeEntriesLoaded:l,updateTimeEntries:p,deleteTimeEntries:I,patchTimeEntries:v}});d.extend($);const w={id:"",description:"",user_id:"",start:"",end:null,duration:null,task_id:null,project_id:null,tags:[],billable:!1,organization_id:"",approval:"",approved_by:""},D=j("currentTimeEntry",()=>{const e=T(M(w)),{handleApiRequestNotifications:l}=F();L("solidtime/current-time-entry",e,{deep:!0});function u(){e.value={...w}}const m=T(null),v=T(null),c=(a,t)=>{const n=d(a).utc(),r=t.diff(n,"second"),f=Math.floor(r/60).toString().padStart(2,"0"),E=(r%60).toString().padStart(2,"0");return`${f}:${E}`};function y(){p(),m.value=d().utc(),v.value=setInterval(()=>{m.value=d().utc(),document.title=`â± ${c(e.value.start,m.value)} - Panso`},1e3)}function p(){v.value!==null&&(clearInterval(v.value),document.title="Dashboard - Panso")}async function z(){if(o())try{const t=await s.getMyActiveTimeEntry({});t!=null&&t.data&&(t.data?(e.value=t.data,e.value.start!==""&&e.value.end===null&&y()):e.value={...w})}catch{e.value={...w}}else throw new Error("Failed to fetch current time entry because organization ID is missing.")}async function _(){const a=o(),t=g();if(a&&t){const n=e.value.start!==""?e.value.start:d().utc().format(),r=await l(()=>{var f,E,q,C;return s.createTimeEntry({member_id:t,start:n,description:(f=e.value)==null?void 0:f.description,project_id:(E=e.value)==null?void 0:E.project_id,task_id:(q=e.value)==null?void 0:q.task_id,billable:e.value.billable,tags:(C=e.value)==null?void 0:C.tags},{params:{organization:a}})},"Timer started!");r!=null&&r.data&&(e.value=r.data)}else throw new Error("Failed to fetch current time entry because organization ID is missing.")}async function b(a){const t=S(),n=o();if(n){const r=d().utc().format();await l(()=>s.updateTimeEntry({user_id:t,start:e.value.start,end:r},{params:{organization:n,timeEntry:e.value.id}}),a||"Timer stopped!"),u()}else throw new Error("Failed to stop current timer because organization ID is missing.")}async function h(){const a=S(),t=o();if(t){const n=await l(()=>s.updateTimeEntry({description:e.value.description,user_id:a,project_id:e.value.project_id,task_id:e.value.task_id,start:e.value.start,billable:e.value.billable,end:null,tags:e.value.tags},{params:{organization:t,timeEntry:e.value.id}}),"Time entry updated!");n!=null&&n.data&&(e.value=n.data)}else throw new Error("Failed to fetch current time entry because organization ID is missing.")}const I=k(()=>e.value?e.value.start!==""&&e.value.start!==null&&e.value.end===null:!1);async function i(a,t){a?(y(),await _()):(p(),await b(t)),N().fetchTimeEntries()}return{currentTimeEntry:e,fetchCurrentTimeEntry:z,updateTimer:h,isActive:I,startLiveTimer:y,stopLiveTimer:p,now:m,setActiveState:i}});export{N as a,D as u};
//# sourceMappingURL=useCurrentTimeEntry-CruyZJNI.js.map
